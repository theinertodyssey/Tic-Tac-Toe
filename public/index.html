<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tic-Tac-Toe</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="/tic-tac-toe.png" type="image/png">
<style>
  :root{
    --primary:#4a6fa5; --secondary:#166088; --accent:#4cb5f5;
    --background:#f8f9fa; --text:#333; --card-bg:#fff; --border:#ddd;
    --shadow:rgba(0,0,0,.1); --success:#28a745; --danger:#dc3545; --warning:#ffc107;
  }
  [data-theme="dark"]{
    --primary:#749de0; --secondary:#d61c3f; --accent:#7cc3ff;
    --text:#e6eefb; --border:#253455;
    --shadow:rgba(0,0,0,.55);
    --background: radial-gradient(1200px 600px at 10% 0%, #0b1220 0%, #0a0f1a 40%, #060a12 100%);
    --card-bg: rgb(16 21 33);
  }
  [data-theme="sunset"]{
    --primary:#d2b22a; --secondary:#ff8c31; --accent:#e9c46a;
    --background:#142b34; --text:#fff; --card-bg:#1317198a; --border:#5c5c5c; --shadow:rgba(0,0,0,.2);
  }
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--background);color:var(--text);min-height:100vh;display:flex;flex-direction:column;line-height:1.6}
  header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border);position:sticky;top:0;-webkit-backdrop-filter:saturate(120%) blur(6px);backdrop-filter:saturate(120%) blur(6px)}
  [data-theme="dark"] header{box-shadow:0 10px 30px var(--shadow);background:rgba(10,15,26,.35)}
  .container{width:100%;max-width:1200px;margin:0 auto;padding:20px}
  .left-head{display:flex;align-items:center;gap:14px}
  .logo{font-size:28px;font-weight:700;color:var(--primary);display:flex;align-items:center;gap:10px}
  .controls{display:flex;gap:12px;align-items:center}
  .theme-selector{display:flex;gap:8px}
  .theme-btn{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid var(--border)}
  .theme-light{background:#f8f9fa}.theme-dark{background:#0b1220}
  .theme-sunset{background:linear-gradient(45deg,#264653,#e76f51)}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--border);background:var(--card-bg);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:0 2px 10px var(--shadow);transition:background-color .3s,color .3s,transform .2s}
  .icon-btn:hover{transform:translateY(-1px)}
  .page{display:none;padding:30px 0;animation:fadeIn .4s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .active{display:block}
  h1{text-align:center;margin-bottom:16px;color:var(--primary)}
  h2{color:var(--secondary);margin-bottom:10px}
  .landing-options{display:flex;justify-content:center;flex-wrap:wrap;gap:24px;margin-top:28px}
  .option-card{background:var(--card-bg);border-radius:16px;padding:24px;width:100%;max-width: 280px;text-align:center;box-shadow:0 16px 36px var(--shadow);cursor:pointer;border:1px solid var(--border);transition:background-color .3s,color .3s,transform .2s,box-shadow .3s}
  [data-theme="dark"] .option-card,[data-theme="dark"] .history,[data-theme="dark"] .stats,[data-theme="dark"] .player-badge,[data-theme="dark"] .toast,[data-theme="dark"] .icon-btn{ -webkit-backdrop-filter:saturate(120%) blur(10px); backdrop-filter:saturate(120%) blur(10px); box-shadow:0 18px 40px var(--shadow), inset 0 1px 0 rgba(255,255,255,.03)}
  .option-card:hover{transform:translateY(-4px)}
  .option-icon{font-size:42px;margin-bottom:14px;color:var(--accent)}
  .option-title{font-size:20px;margin-bottom:8px;color:var(--primary)}
  .form-group{margin-bottom:16px;text-align:left}
  label{display:block;margin-bottom:8px;font-weight:600}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--card-bg);color:var(--text);font-size:16px}
  input:focus,select:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:transparent}
  .btn{padding:12px 18px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer;font-size:16px;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 10px 22px var(--shadow);transition:background-color .3s,color .3s,transform .2s,box-shadow .3s}
  .btn:hover{background:var(--secondary);transform:translateY(-2px)}
  .btn-secondary{background:var(--secondary)}
  .btn-success{background:var(--success)}
  .btn-danger{background:var(--danger)}
  .btn-warning{background:var(--warning);color:#111}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .game-container{display:flex;flex-direction:column;align-items:center;gap:24px}
  .game-board {
    width: 92vw;                 
    max-width: 420px;             
    display: grid;
    grid-template-columns: repeat(3,1fr);
    gap: 10px;
    margin: 10px auto;
  }
  .cell{width:100%;aspect-ratio:1/1;background:var(--card-bg);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:clamp(28px,10vw,44px);font-weight:900;cursor:pointer;box-shadow:0 10px 22px var(--shadow);user-select:none;border:1px solid var(--border);transition:background-color .2s,transform .1s,box-shadow .2s}
  .cell:hover{background:var(--card-bg)}
  @supports (background: color-mix(in srgb, white, black)) {.cell:hover{background:color-mix(in srgb, var(--accent) 24%, var(--card-bg))}}
  .cell:focus{outline:3px solid var(--accent);outline-offset:2px}
  .cell.x{color:var(--danger)} .cell.o{color:var(--primary)}
  .cell.win{box-shadow:0 0 0 3px var(--success) inset, 0 12px 26px var(--shadow);transform:scale(1.03)}
  .game-info{display:flex;flex-direction:column;align-items:center;gap:12px}
  .player-turn{font-size:18px;font-weight:800;padding:10px 16px;border-radius:999px;background:var(--card-bg);box-shadow:0 8px 16px var(--shadow);border:1px solid var(--border)}
  .history-stats{display:flex;gap:20px;margin-top:10px;flex-wrap:wrap;justify-content:center}
  .history,.stats{background:var(--card-bg);border-radius:16px;padding:18px;width:100%;max-width:520px;box-shadow:0 12px 24px var(--shadow);border:1px solid var(--border)}
  .history h3,.stats h3{margin-bottom:10px;color:var(--primary);display:flex;align-items:center;gap:10px}
  .history-list{max-height:260px;overflow-y:auto}
  .history-item{padding:10px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:3px}
  .history-line1{display:flex;justify-content:space-between;gap:10px;font-weight:700}
  .history-line2{display:flex;justify-content:space-between;gap:10px;font-size:13px;opacity:.9;flex-wrap:wrap}
  .stat-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
  .action-buttons{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;justify-content:center}
  .player-info{display:flex;gap:12px;justify-content:center;margin:6px 0;flex-wrap:wrap}
  .player-badge{padding:8px 14px;border-radius:999px;background:var(--card-bg);box-shadow:0 8px 16px var(--shadow);display:flex;align-items:center;gap:10px;border:1px solid var(--border)}
  .player-badge.x{border-left:5px solid var(--danger)} .player-badge.o{border-left:5px solid var(--primary)}
  .room-code{font-size:22px;font-weight:800;letter-spacing:2px;text-align:center;padding:12px;background:var(--card-bg);border-radius:12px;margin:12px 0;font-family:ui-monospace,Consolas,monospace;border:1px solid var(--border)}
  .toast{position:fixed;bottom:20px;right:20px;padding:14px 20px;background:var(--card-bg);color:var(--text);border-radius:12px;box-shadow:0 14px 30px rgba(0,0,0,.25);display:flex;align-items:center;gap:10px;transform:translateY(120px);opacity:0;transition:transform .3s,opacity .3s;z-index:1000;border:1px solid var(--border)}
  .toast.show{transform:translateY(0);opacity:1}
  .toast.success{border-left:4px solid var(--success)} .toast.error{border-left:4px solid var(--danger)} .toast.info{border-left:4px solid var(--accent)}
  @media (max-width:768px){ .landing-options{flex-direction:column;align-items:center} .history-stats{flex-direction:column} .player-info{flex-direction:column;align-items:center} .action-buttons{flex-direction:column}}
  .connection-status{display:flex;align-items:center;gap:8px;font-size:14px;margin-top:10px}
  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .status-connected{background:var(--success)} .status-disconnected{background:var(--danger)} .status-connecting{background:var(--warning)}
  @media (prefers-reduced-motion: reduce){ *{transition:none !important; animation:none !important} }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="left-head">
        <div class="logo"><i class="fa-solid fa-gamepad"></i><span>Tic-Tac-Toe</span></div>
        <button class="icon-btn" id="sound-toggle" aria-pressed="true" title="Toggle sound">
          <i id="sound-icon" class="fa-solid fa-volume-high"></i><span id="sound-label" class="sr-only">Sound on</span>
        </button>
      </div>
      <div class="controls">
        <div class="theme-selector" role="group" aria-label="Theme selector">
          <div class="theme-btn theme-light" data-theme="light" title="Light theme" aria-label="Switch to Light" role="button" tabindex="0" aria-pressed="false"></div>
          <div class="theme-btn theme-dark" data-theme="dark" title="Dark theme" aria-label="Switch to Dark" role="button" tabindex="0" aria-pressed="false"></div>
          <div class="theme-btn theme-sunset" data-theme="sunset" title="Sunset theme" aria-label="Switch to Sunset" role="button" tabindex="0" aria-pressed="false"></div>
        </div>
      </div>
    </header>

    <section id="landing-page" class="page active">
      <h1>Simple - Advance - Minimal</h1>
      <p style="text-align:center;margin-bottom:18px;">Select your preferred game mode:</p>
      <div class="landing-options">
        <div class="option-card" id="local-option" role="button" tabindex="0" aria-label="Local play setup">
          <div class="option-icon"><i class="fa-solid fa-users"></i></div>
          <h2 class="option-title">Local Play</h2>
          <p class="option-description">Play against a friend or the computer</p>
        </div>
        <div class="option-card" id="Multiplayer-option" role="button" tabindex="0" aria-label="Online Multiplayer">
          <div class="option-icon"><i class="fa-solid fa-globe"></i></div>
          <h2 class="option-title">Online Multiplayer</h2>
          <p class="option-description">Create a room or join one</p>
        </div>
      </div>
    </section>

    <section id="local-setup" class="page">
      <h1>Local Game Setup</h1>
      <div class="mode-selection" style="display:flex;gap:10px;justify-content:center;margin-bottom:18px;">
        <button class="btn" id="PVP-btn"><i class="fa-solid fa-user-group"></i> Player vs Player</button>
        <button class="btn" id="CPU-btn"><i class="fa-solid fa-robot"></i> Player vs CPU</button>
      </div>

      <div id="PVP-setup" style="display:none;max-width:420px;margin:0 auto;">
        <div class="form-group">
          <label for="playerX"><i class="fa-solid fa-xmark"></i> - Player Name</label>
          <input type="text" id="playerX" placeholder="Player X" value="Player X" maxlength="24">
        </div>
        <div class="form-group">
          <label for="playerO"><i class="fa-regular fa-circle"></i> - Player Name</label>
          <input type="text" id="playerO" placeholder="Player O" value="Player O" maxlength="24">
        </div>
        <div class="form-group">
          <label for="firstTurnPVP"><i class="fa-regular fa-hand-point-right"></i> Who starts?</label>
          <select id="firstTurnPVP">
            <option value="X" selected>X</option>
            <option value="O">O</option>
            <option value="random">Random</option>
          </select>
        </div>
        <button class="btn btn-success" id="start-PVP"><i class="fa-solid fa-play"></i> Start Game</button>
      </div>

      <div id="CPU-setup" style="display:none;max-width:420px;margin:0 auto;">
        <div class="form-group">
          <label for="humanPlayer"><i class="fa-regular fa-user"></i> Your Name</label>
          <input type="text" id="humanPlayer" placeholder="Your Name" value="You" maxlength="24">
        </div>
        <div class="form-group">
          <label for="playAs"><i class="fa fa-paperclip"></i> You play as</label>
          <select id="playAs">
            <option value="X" selected>X</option>
            <option value="O">O</option>
          </select>
        </div>
        <div class="form-group">
          <label for="difficulty"><i class="fa-solid fa-sliders"></i> Difficulty Level</label>
          <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <button class="btn btn-success" id="start-CPU"><i class="fa-solid fa-play"></i> Start Game</button>
      </div>

      <div style="text-align:center;margin-top:20px;">
        <button class="btn btn-secondary" id="back-from-local"><i class="fa-solid fa-arrow-left"></i> Back</button>
      </div>
    </section>

    <section id="Multiplayer-setup" class="page">
      <h1>Online Multiplayer</h1>
      <div style="max-width:520px;margin:0 auto;">
        <div class="form-group">
          <label for="playerName"><i class="fa-regular fa-user"></i> Your Name</label>
          <input type="text" id="playerName" placeholder="Enter your name" value="Player" maxlength="24">
        </div>
        <div class="Multiplayer-options" style="display:flex;flex-direction:column;gap:14px;margin-top:10px;">
          <button class="btn btn-success" id="create-room"><i class="fa-solid fa-plus"></i> Create Room</button>
          <p style="text-align:center;">Or</p>
          <div class="form-group">
            <label for="roomCode"><i class="fa-solid fa-door-open"></i> Enter Room Code</label>
            <input type="text" id="roomCode" placeholder="6-character code" maxlength="6" style="text-transform:uppercase;">
          </div>
          <button class="btn btn-success" id="join-room"><i class="fa-solid fa-right-to-bracket"></i> Join Room</button>
        </div>

        <div id="room-created" style="display:none;text-align:center;margin-top:20px;">
          <p>Share this code with your friend:</p>
          <div class="room-code" id="room-code-display" aria-live="polite">ABCD12</div>
          <p><i class="fa-regular fa-clock"></i> Waiting for opponent to join...</p>
          <div class="connection-status">
            <span class="status-dot status-connecting" id="status-dot"></span>
            <span id="connection-label">Connecting...</span>
          </div>
        </div>

        <div style="text-align:center;margin-top:20px;">
          <button class="btn btn-secondary" id="back-from-Multiplayer"><i class="fa-solid fa-arrow-left"></i> Back</button>
        </div>
      </div>
    </section>

    <section id="game-page" class="page" aria-live="polite">
      <h1>Tic Tac Toe</h1>
      <div class="player-info">
        <div class="player-badge x"><i class="fa-solid fa-xmark"></i><span id="player-x-name">Player X</span></div>
        <div class="player-badge o"><i class="fa-regular fa-circle"></i><span id="player-o-name">Player O</span></div>
      </div>

      <div class="game-container">
        <div class="game-info">
          <div class="player-turn" id="turn-indicator" aria-live="polite">X — Player X's Turn</div>
          <div class="game-board" id="game-board" role="grid" aria-label="Tic Tac Toe board">
            <div class="cell" data-index="0" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="1" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="2" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="3" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="4" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="5" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="6" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="7" role="gridcell" tabindex="0" aria-label="Empty"></div>
            <div class="cell" data-index="8" role="gridcell" tabindex="0" aria-label="Empty"></div>
          </div>

          <div class="action-buttons">
            <button class="btn btn-warning" id="undo-move" disabled><i class="fa-solid fa-rotate-left"></i> Undo</button>
            <button class="btn btn-warning" id="restart-game"><i class="fa-solid fa-rotate-right"></i> Restart</button>
          </div>
        </div>

        <div class="history-stats">
          <div class="history">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> Game History</h3>
            <div class="history-list" id="history-list"></div>
            <button class="btn btn-secondary" id="clear-history"><i class="fa-solid fa-trash"></i> Clear History</button>
          </div>
          <div class="stats">
            <h3><i class="fa-solid fa-chart-bar"></i> Statistics</h3>
            <div id="stats-content">
              <div class="stat-item"><span>Games Played:</span><span id="games-played">0</span></div>
              <div class="stat-item"><span>X Wins:</span><span id="x-wins">0</span></div>
              <div class="stat-item"><span>O Wins:</span><span id="o-wins">0</span></div>
              <div class="stat-item"><span>Draws:</span><span id="draws">0</span></div>
            </div>
            <button class="btn btn-secondary" id="reset-stats"><i class="fa-solid fa-undo"></i> Reset Statistics</button>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary" id="back-to-menu"><i class="fa-solid fa-house"></i> Back to Menu</button>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status">
    <i class="fa-solid fa-circle-info"></i>
    <span id="toast-message"></span>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
const LS = {
  stats: 'tictactoe_stats',
  history: 'tictactoe_history',
  theme: 'theme',
  sound: 'soundOn',
  namesPVP: 'ttt_names_PVP',
  nameCPU: 'ttt_name_CPU',
  CPUPrefs: 'ttt_CPU_prefs',
  nameMp: 'ttt_name_mp'
};

function safeGetJSON(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch{ return fallback; }
}

const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');
function showToast(message, type='info'){ toastMessage.textContent = message; toast.className='toast show '+type; setTimeout(()=>{toast.className='toast';}, 2400); }

const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let soundOn = JSON.parse(localStorage.getItem(LS.sound) || 'true');
const soundToggle = document.getElementById('sound-toggle');
const soundIcon = document.getElementById('sound-icon');
const soundLabel = document.getElementById('sound-label');
function updateSoundUI(){
  soundToggle.setAttribute('aria-pressed', String(soundOn));
  soundIcon.className = soundOn ? 'fa-solid fa-volume-high' : 'fa-solid fa-volume-xmark';
  soundLabel.textContent = soundOn ? 'Sound on' : 'Sound off';
}
updateSoundUI();
window.addEventListener('pointerdown', ()=>{ if(soundOn) ensureAudio(); }, { once:true });
soundToggle.addEventListener('click', ()=>{
  soundOn = !soundOn;
  localStorage.setItem(LS.sound, JSON.stringify(soundOn));
  updateSoundUI();
  if(soundOn){ ensureAudio(); sfx(820,0.07,0.14); showToast('Sound on','success'); }
  else{ showToast('Sound off','info'); }
});
function ensureAudio(){ try{ if(!audioCtx) audioCtx = new AudioCtx(); if(audioCtx.state==='suspended') audioCtx.resume(); }catch(e){} }
function ping(freq=660, dur=0.07, vol=0.12){
  if(!audioCtx) return;
  const t = audioCtx.currentTime, o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.frequency.value = freq; o.type='sine';
  g.gain.setValueAtTime(vol, t); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+dur);
}
function sfx(...args){ if(!soundOn) return; ensureAudio(); ping(...args); }
function winSound(){ sfx(900,0.09,0.15); setTimeout(()=>sfx(1200,0.12,0.13), 90); }
function drawSound(){
  sfx(400,0.1,0.14); 
  setTimeout(()=>sfx(500,0.08,0.12),120);
  setTimeout(()=>sfx(300,0.12,0.1),240);
}

function setTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem(LS.theme, theme);
  document.querySelectorAll('.theme-btn').forEach(b=>{
    const active = b.getAttribute('data-theme')===theme;
    b.setAttribute('aria-pressed', String(active));
  });
  sfx(780, 0.07, 0.12)
  const themeNames = { light: 'Light', dark: 'Dark', sunset: 'Sunset' };
  showToast(`Theme: ${themeNames[theme] || theme}`, 'success');
}
document.querySelectorAll('.theme-btn').forEach(btn=>{
  btn.addEventListener('keydown', e=>{
    if(e.key==='Enter' || e.key===' ' || e.key==='Space'){ e.preventDefault(); btn.click(); }
  });
  btn.addEventListener('click', ()=>{
    const theme = btn.getAttribute('data-theme');
    setTheme(theme);
  });
});
const savedTheme = localStorage.getItem(LS.theme) || 'light';
setTheme(savedTheme);

const pages = {
  landing: document.getElementById('landing-page'),
  localSetup: document.getElementById('local-setup'),
  MultiplayerSetup: document.getElementById('Multiplayer-setup'),
  game: document.getElementById('game-page')
};
function showPage(page){ Object.values(pages).forEach(p=>p.classList.remove('active')); page.classList.add('active'); }
function kbActivate(el){ el.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '||e.key==='Space'){ e.preventDefault(); el.click(); }}); }
kbActivate(document.getElementById('local-option'));
kbActivate(document.getElementById('Multiplayer-option'));
document.getElementById('local-option').addEventListener('click',()=>showPage(pages.localSetup));
document.getElementById('Multiplayer-option').addEventListener('click',()=>showPage(pages.MultiplayerSetup));
document.getElementById('back-from-local').addEventListener('click',()=>{ leaveRoomIfAny(); showPage(pages.landing); });
document.getElementById('back-from-Multiplayer').addEventListener('click',()=>{ leaveRoomIfAny(); showPage(pages.landing); });
document.getElementById('back-to-menu').addEventListener('click',()=>{ leaveRoomIfAny(); showPage(pages.landing); });

const cells = [...document.querySelectorAll('.cell')];
const turnIndicator = document.getElementById('turn-indicator');

const gameState = {
  board: Array(9).fill(''),
  currentPlayer: 'X',
  gameType: '', 
  players: { X:'Player X', O:'Player O' },
  difficulty: 'medium',
  gameActive: true,
  score: { X:0, O:0, draws:0 },
  roomCode: null,
  isHost: false,
  mySymbol: null,
  humanSymbol: 'X',
  CPUSymbol: 'O',
  historyMoves: [],
  startTime: null,
  movesCount: 0
};

cells.forEach((cell,i)=>{
  cell.setAttribute('aria-rowindex', String(Math.floor(i/3)+1));
  cell.setAttribute('aria-colindex', String(i%3+1));
});

function initPersistence(){
  const saved = safeGetJSON(LS.stats, null);
  if(saved){ gameState.score = saved; updateStatsDisplay(); }
  const hist = safeGetJSON(LS.history, null);
  if(hist){ updateHistoryDisplay(hist); }
  initNameFormsFromStorage();
}
initPersistence();

function initNameFormsFromStorage(){
  const PVP = safeGetJSON(LS.namesPVP, null);
  if(PVP){ const x = document.getElementById('playerX'); const o = document.getElementById('playerO'); if(x && PVP.X) x.value = PVP.X; if(o && PVP.O) o.value = PVP.O; }
  const CPUName = localStorage.getItem(LS.nameCPU);
  if(CPUName){ const h = document.getElementById('humanPlayer'); if(h) h.value = CPUName; }
  const prefs = safeGetJSON(LS.CPUPrefs, null);
  if(prefs){ const playAs = document.getElementById('playAs'); const diff = document.getElementById('difficulty'); if(playAs && prefs.playAs) playAs.value = prefs.playAs; if(diff && prefs.difficulty) diff.value = prefs.difficulty; }
  const mpName = localStorage.getItem(LS.nameMp);
  if(mpName){ const p = document.getElementById('playerName'); if(p) p.value = mpName; }
}

document.getElementById('PVP-btn').addEventListener('click', ()=>{
  document.getElementById('PVP-setup').style.display='block';
  document.getElementById('CPU-setup').style.display='none';
});
document.getElementById('CPU-btn').addEventListener('click', ()=>{
  document.getElementById('PVP-setup').style.display='none';
  document.getElementById('CPU-setup').style.display='block';
});

document.getElementById('start-PVP').addEventListener('click', ()=>{
  const playerX = (document.getElementById('playerX').value || 'Player X').trim();
  const playerO = (document.getElementById('playerO').value || 'Player O').trim();
  let first = document.getElementById('firstTurnPVP').value;
  if(first==='random') first = Math.random()<0.5?'X':'O';

  localStorage.setItem(LS.namesPVP, JSON.stringify({X:playerX, O:playerO}));

  Object.assign(gameState, { players:{X:playerX, O:playerO}, gameType:'PVP', humanSymbol:null, CPUSymbol:null, mySymbol:null });
  startGame(first);
});

document.getElementById('start-CPU').addEventListener('click', ()=>{
  const human = (document.getElementById('humanPlayer').value || 'Player').trim();
  const playAs = document.getElementById('playAs').value;
  const difficulty = document.getElementById('difficulty').value;
  const CPUName = 'CPU ('+difficulty+')';

  localStorage.setItem(LS.nameCPU, human);
  localStorage.setItem(LS.CPUPrefs, JSON.stringify({ playAs, difficulty }));

  gameState.players[playAs] = human;
  gameState.players[playAs==='X'?'O':'X'] = CPUName;
  gameState.gameType='CPU';
  gameState.difficulty = difficulty;
  gameState.humanSymbol = playAs;
  gameState.CPUSymbol = playAs==='X'?'O':'X';
  gameState.mySymbol = playAs; 
  startGame('X'); 
});

function startGame(first='X'){
  document.getElementById('player-x-name').textContent = gameState.players.X;
  document.getElementById('player-o-name').textContent = gameState.players.O;
  showPage(pages.game);
  resetBoard(first);

  if(gameState.gameType==='CPU' && gameState.CPUSymbol==='X'){
    setTimeout(makeCPUMove, 350);
  }

  document.getElementById('undo-move').disabled = (gameState.gameType === 'Multiplayer');
}

function resetBoard(first='X'){
  gameState.board = Array(9).fill('');
  gameState.currentPlayer = first;
  gameState.gameActive = true;
  gameState.historyMoves = [];
  gameState.startTime = Date.now();
  gameState.movesCount = 0;
  document.querySelectorAll('.cell').forEach(c=>{
    c.textContent=''; c.classList.remove('x','o','win'); c.setAttribute('aria-label','Empty');
  });
  updateTurnIndicator();
  if(gameState.gameType!=='Multiplayer'){ document.getElementById('undo-move').disabled = true; }
}

function updateTurnIndicator(){
  const s = gameState.currentPlayer;
  const name = gameState.players[s];
  const prefix = (gameState.gameType==='Multiplayer' && gameState.mySymbol===s) ? '' : '';
  turnIndicator.textContent = `${s} — ${prefix}${name}'s Turn`;
}

function markCell(index, symbol){
  const cell = document.querySelector(`.cell[data-index="${index}"]`);
  cell.textContent = symbol;
  cell.classList.add(symbol.toLowerCase());
  cell.setAttribute('aria-label', symbol);
}

cells.forEach(cell=>{
  cell.addEventListener('click', onCellClick);
  cell.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '||e.key==='Space'){ e.preventDefault(); cell.click(); }});
});

function onCellClick(e){
  const idx = +e.currentTarget.getAttribute('data-index');

  if(gameState.gameType==='Multiplayer'){
    if(!gameState.gameActive) return;
    if(gameState.board[idx] !== '') return;
    if(gameState.currentPlayer !== gameState.mySymbol) return;
    socket.emit('playerMove', { index: idx });
    return;
  }

  if(!gameState.gameActive || gameState.board[idx] !== '') return;
  if(gameState.gameType==='CPU' && gameState.currentPlayer !== gameState.humanSymbol) return;

  makeMove(idx, gameState.currentPlayer);
  sfx(700, .05, .10);

  const winInfo = checkWinPattern();
  if(winInfo){ endGame(false, winInfo); return; }
  if(checkDraw()){ endGame(true); return; }

  switchTurn();
  if(gameState.gameType==='CPU' && gameState.currentPlayer===gameState.CPUSymbol){
    setTimeout(makeCPUMove, 350);
  }
}

function makeMove(index, symbol){
  gameState.board[index] = symbol;
  markCell(index, symbol);
  gameState.historyMoves.push({index, symbol});
  gameState.movesCount++;
  if(gameState.gameType!=='Multiplayer'){ document.getElementById('undo-move').disabled = false; }
}

document.getElementById('undo-move').addEventListener('click', ()=>{
  if(gameState.gameType==='Multiplayer'){ showToast('Undo is disabled in online games', 'error'); return; }
  if(!gameState.gameActive) return;
  if(!gameState.historyMoves.length) return;

  const popOnce = ()=>{
    const last = gameState.historyMoves.pop();
    if(!last) return false;
    gameState.board[last.index] = '';
    const cell = document.querySelector(`.cell[data-index="${last.index}"]`);
    cell.textContent=''; cell.classList.remove('x','o','win'); cell.setAttribute('aria-label','Empty');
    gameState.currentPlayer = last.symbol;
    gameState.movesCount = Math.max(0, gameState.movesCount - 1);
    return true;
  };

  if(gameState.gameType==='CPU'){
    popOnce();
    if(gameState.currentPlayer !== gameState.humanSymbol) popOnce();
  } else {
    popOnce();
  }

  document.getElementById('undo-move').disabled = gameState.historyMoves.length===0;
  gameState.gameActive = true;
  updateTurnIndicator();
});

document.getElementById('restart-game').addEventListener('click', ()=>{
  if(gameState.gameType==='Multiplayer'){
    socket.emit('restartGame');
    return;
  }
  if(confirm('Restart the current game?')){
    resetBoard('X');
    if(gameState.gameType==='CPU' && gameState.CPUSymbol==='X'){
      setTimeout(makeCPUMove, 350);
    }
  }
});

function getBestMove(){
  const CPU = gameState.CPUSymbol, human = gameState.humanSymbol;
  const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  const evaluate = (b)=>{
    for(const [a,b1,c] of lines){ if(b[a] && b[a]===b[b1] && b[a]===b[c]) return b[a]===CPU ? 10 : -10; }
    return 0;
  };
  const movesLeft = (b)=> b.some(c=>c==='');
  function minimax(board, depth, isMax){
    const score = evaluate(board);
    if(score===10) return score - depth;
    if(score===-10) return score + depth;
    if(!movesLeft(board)) return 0;
    if(isMax){
      let best = -Infinity;
      for(let i=0;i<9;i++) if(board[i]===''){ board[i]=CPU; best=Math.max(best, minimax(board, depth+1, false)); board[i]=''; }
      return best;
    }else{
      let best = Infinity;
      for(let i=0;i<9;i++) if(board[i]===''){ board[i]=human; best=Math.min(best, minimax(board, depth+1, true)); board[i]=''; }
      return best;
    }
  }
  const order = [4,0,2,6,8,1,3,5,7];
  let bestVal = -Infinity, bestMove = null;
  for(const i of order) if(gameState.board[i]===''){
    gameState.board[i]=CPU; const val = minimax(gameState.board, 0, false); gameState.board[i]='';
    if(val>bestVal){ bestVal=val; bestMove=i; }
  }
  return bestMove;
}

function makeCPUMove(){
  if(!gameState.gameActive || gameState.currentPlayer!==gameState.CPUSymbol) return;
  let move;
  if(gameState.difficulty==='easy') move = getRandomMove();
  else if(gameState.difficulty==='medium') move = getMediumMove();
  else move = getBestMove();

  if(move==null) return;
  makeMove(move, gameState.CPUSymbol);
  sfx(520, .05, .10);

  const winInfo = checkWinPattern();
  if(winInfo){ endGame(false, winInfo); return; }
  if(checkDraw()){ endGame(true); return; }
  switchTurn();
}

function switchTurn(){ gameState.currentPlayer = gameState.currentPlayer==='X' ? 'O' : 'X'; updateTurnIndicator(); }
function getRandomMove(){ const a = gameState.board.map((c,i)=>c===''?i:null).filter(i=>i!==null); return a.length? a[Math.floor(Math.random()*a.length)]:null; }
function getMediumMove(){
  for(let i=0;i<9;i++) if(gameState.board[i]===''){ gameState.board[i]=gameState.CPUSymbol; if(checkWinPattern()){ gameState.board[i]=''; return i; } gameState.board[i]=''; }
  const opp = gameState.CPUSymbol==='X'?'O':'X';
  for(let i=0;i<9;i++) if(gameState.board[i]===''){ gameState.board[i]=opp; if(checkWinPattern()){ gameState.board[i]=''; return i; } gameState.board[i]=''; }
  return getRandomMove();
}
function checkWinPattern(){
  const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const [a,b,c] of wins){
    if(gameState.board[a] && gameState.board[a]===gameState.board[b] && gameState.board[a]===gameState.board[c]){
      return {winner: gameState.board[a], pattern:[a,b,c]};
    }
  } return null;
}
function checkDraw(){ return !gameState.board.includes(''); }

function endGame(isDraw, winInfo){
  gameState.gameActive = false;
  let resultText, winner = null;
  if(isDraw){
    resultText = "It's a draw!"; gameState.score.draws++; drawSound();
  }else{
    winner = winInfo?.winner ?? gameState.currentPlayer;
    resultText = `${gameState.players[winner]} wins!`; gameState.score[winner]++; winSound();
    if(winInfo?.pattern){ winInfo.pattern.forEach(i=> document.querySelector(`.cell[data-index="${i}"]`).classList.add('win')); }
  }
  turnIndicator.textContent = resultText;
  document.getElementById('undo-move').disabled = true;

  const endTime = Date.now();
  addToHistory({
    startTime: gameState.startTime,
    endTime,
    durationMs: Math.max(0, endTime - (gameState.startTime||endTime)),
    type: gameState.gameType,
    difficulty: gameState.gameType==='CPU' ? gameState.difficulty : null,
    players: {...gameState.players},
    firstPlayer: gameState.historyMoves[0]?.symbol || 'X',
    moves: gameState.movesCount,
    result: resultText,
    winnerSymbol: winner
  });
  updateStats();
}

function updateStats(){ localStorage.setItem(LS.stats, JSON.stringify(gameState.score)); updateStatsDisplay(); }
function updateStatsDisplay(){
  document.getElementById('games-played').textContent = (gameState.score.X + gameState.score.O + gameState.score.draws);
  document.getElementById('x-wins').textContent = gameState.score.X;
  document.getElementById('o-wins').textContent = gameState.score.O;
  document.getElementById('draws').textContent = gameState.score.draws;
}
function formatDateTime(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return ''+ts; } }
function formatDuration(ms){
  const s = Math.floor(ms/1000), h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  return (h?String(h).padStart(2,'0')+':':'') + String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
}
function addToHistory(entry){
  const history = safeGetJSON(LS.history, []);
  history.unshift(entry);
  localStorage.setItem(LS.history, JSON.stringify(history));
  updateHistoryDisplay(history);
}
function updateHistoryDisplay(history){
  const list = document.getElementById('history-list');
  list.innerHTML='';
  (history||[]).slice(0,12).forEach(game=>{
    const item = document.createElement('div'); item.className='history-item';
    const l1 = document.createElement('div'); l1.className='history-line1';
    const left = document.createElement('span'); const pX = game.players?.X ?? 'X', pO = game.players?.O ?? 'O';
    left.textContent = `${pX} vs ${pO}`;
    const right = document.createElement('span'); right.textContent = game.result || '';
    l1.append(left,right);

    const l2 = document.createElement('div'); l2.className='history-line2';
    const start = document.createElement('span'); start.textContent = `Start: ${formatDateTime(game.startTime)}`;
    const end = document.createElement('span'); end.textContent = `End: ${formatDateTime(game.endTime)}`;
    const dur = document.createElement('span'); dur.textContent = `Duration: ${formatDuration(game.durationMs||0)}`;
    const mode = document.createElement('span'); mode.textContent = `Mode: ${game.type ?? 'local'}` + (game.difficulty?` (${game.difficulty})`:'');
    const moves = document.createElement('span'); moves.textContent = `Moves: ${game.moves ?? '-'}`;
    l2.append(start,end,dur,mode,moves);

    item.append(l1,l2);
    list.appendChild(item);
  });
}
document.getElementById('clear-history').addEventListener('click', ()=>{
  if(confirm('Clear game history? This cannot be undone.')){
    localStorage.removeItem(LS.history);
    document.getElementById('history-list').innerHTML='';
    showToast('History cleared','success');
  }
});
document.getElementById('reset-stats').addEventListener('click', ()=>{
  if(confirm('Reset all statistics?')){
    gameState.score = {X:0, O:0, draws:0};
    localStorage.removeItem(LS.stats);
    updateStatsDisplay();
    showToast('Statistics reset','success');
  }
});

const statusDot = document.getElementById('status-dot');
const connectionLabel = document.getElementById('connection-label');
function setConn(state){
  if(!statusDot || !connectionLabel) return;
  statusDot.classList.remove('status-connecting','status-connected','status-disconnected');
  if(state==='connecting'){ statusDot.classList.add('status-connecting'); connectionLabel.textContent='Connecting...'; }
  if(state==='connected'){ statusDot.classList.add('status-connected'); connectionLabel.textContent='Connected. Waiting for opponent...'; }
  if(state==='disconnected'){ statusDot.classList.add('status-disconnected'); connectionLabel.textContent='Disconnected'; }
}

let socket = null;

function ensureSocket(){
  if(socket) return socket;
  socket = io(); 
  socket.on('connect', ()=> setConn('connected'));
  socket.on('disconnect', ()=> { setConn('disconnected'); showToast('Disconnected from server','error'); });
  socket.on('connect_error', ()=> { setConn('disconnected'); showToast('Connection error','error'); });

  socket.on('roomCreated', ({ code, yourSymbol })=>{
    gameState.roomCode = code;
    gameState.isHost = true;
    gameState.mySymbol = yourSymbol;
    document.getElementById('room-code-display').textContent = code;
    document.getElementById('room-created').style.display = 'block';
    showToast('Room created. Share the code!','success');
  });

  socket.on('roomError', ({ message })=>{
    showToast(message || 'Room error', 'error');
  });

  socket.on('gameStart', ({ code, players, currentPlayer })=>{
    gameState.roomCode = code;
    gameState.players = players;
    gameState.gameType = 'Multiplayer';
    gameState.isHost = (gameState.mySymbol === 'X');
    document.getElementById('player-x-name').textContent = players.X;
    document.getElementById('player-o-name').textContent = players.O;
    showToast('Opponent joined! Game starting...','success');
    startGame(currentPlayer || 'X');
  });

  socket.on('moveMade', ({ index, symbol })=>{
    if(gameState.board[index] === ''){
      makeMove(index, symbol);
      sfx(symbol==='X'?700:520, .05, .10);
    }
  });

  socket.on('turn', ({ currentPlayer })=>{
    gameState.currentPlayer = currentPlayer;
    updateTurnIndicator();
  });

  socket.on('gameOver', ({ winnerSymbol, pattern, draw })=>{
    if(draw){ endGame(true); return; }
    endGame(false, { winner: winnerSymbol, pattern: pattern||[] });
  });

  socket.on('gameRestarted', ({ currentPlayer })=>{
    resetBoard(currentPlayer || 'X');
  });

  socket.on('opponentLeft', ()=>{
    showToast('Opponent left the game','error');
    setConn('connected');
    if(gameState.isHost){
      showPage(pages.MultiplayerSetup);
      document.getElementById('room-created').style.display = 'block';
    } else {
      leaveRoomIfAny();
      showPage(pages.MultiplayerSetup);
    }
  });

  return socket;
}

document.getElementById('create-room').addEventListener('click', ()=>{
  const playerName = (document.getElementById('playerName').value || 'Player').trim();
  localStorage.setItem(LS.nameMp, playerName);
  ensureSocket().emit('createRoom', { name: playerName });
  setConn('connecting');
});

document.getElementById('join-room').addEventListener('click', ()=>{
  const playerName = (document.getElementById('playerName').value || 'Player').trim();
  const roomCode = (document.getElementById('roomCode').value || '').toUpperCase();
  if(roomCode.length!==6){ showToast('Enter a valid 6-character code','error'); return; }
  localStorage.setItem(LS.nameMp, playerName);
  const s = ensureSocket();
  s.emit('joinRoom', { code: roomCode, name: playerName });
  gameState.mySymbol = 'O';
  setConn('connecting');
});

function leaveRoomIfAny(){
  try{
    if(socket && gameState.roomCode){
      socket.emit('leaveRoom');
    }
  }catch(e){}
  gameState.roomCode = null;
  gameState.isHost = false;
  gameState.mySymbol = null;
  const rc = document.getElementById('room-created');
  if(rc) rc.style.display = 'none';
}

</script>
</body>
</html>
